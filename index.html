<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆå•AIçš„è‚¡ç¥¨èˆ‡æœŸæ¬Šç¶œåˆåˆ†æ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px; /* Add space between cards */
        }
        .button-primary {
            background-color: #4f46e5;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .button-primary:hover {
            background-color: #4338ca;
        }
        .input-field, .textarea-field {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 10px 14px;
            width: 100%;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-field:focus, .textarea-field:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .file-input-label {
            display: inline-block;
            background-color: #e0e7ff;
            color: #4f46e5;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        .file-input-label:hover {
            background-color: #c7d2fe;
        }
        .preview-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-height: 200px; /* Limit height for multiple images */
            object-fit: contain; /* Ensure image fits without distortion */
        }
        .image-preview-item {
            position: relative;
            margin: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
        }
        .remove-image-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            z-index: 10;
            transition: background-color 0.2s;
        }
        .remove-image-btn:hover {
            background-color: #dc2626;
        }

        /* Stock Line Animation */
        .stock-line-animation {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }
        .stock-line-animation svg {
            width: 24px;
            height: 24px;
        }
        .stock-line-animation polyline {
            stroke: #ffffff;
            stroke-width: 2.5;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            animation: floatUpAndDown 1.5s ease-in-out infinite;
        }
        @keyframes floatUpAndDown {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        /* Markdown table styling */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
            margin-bottom: 1em;
        }
        .prose th, .prose td {
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            text-align: left;
        }
        .prose th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        /* Ensure text wraps within prose blocks */
        .prose {
            word-break: break-word; /* For older browsers */
            overflow-wrap: break-word; /* Standard property */
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div class="container mx-auto">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-8 mt-4">æˆå•AIçš„è‚¡ç¥¨èˆ‡æœŸæ¬Šç¶œåˆåˆ†æ</h1>

        <div class="card p-6 sm:p-8 mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">ä¸Šå‚³è³‡è¨Šèˆ‡è¼¸å…¥æè¿°</h2>

            <!-- åœ–ç‰‡ä¸Šå‚³å€å¡Š (æ”¯æ´å¤šåœ–) -->
            <div class="mb-6">
                <label for="chartInputs" class="block text-gray-700 text-lg font-medium mb-3">ä¸Šå‚³åœ–è¡¨ (å¯å¤šé¸ï¼Œæ”¯æ´ PNG/JPG/JPEG)</label>
                <input type="file" id="chartInputs" accept="image/*" multiple class="hidden" onchange="previewMultipleImages(event)">
                <label for="chartInputs" class="file-input-label">é¸æ“‡åœ–ç‰‡æª”æ¡ˆ</label>
                <div id="imagePreviewContainer" class="flex flex-wrap mt-4">
                    <!-- Image previews will be dynamically added here -->
                </div>
            </div>

            <!-- æ–‡å­—æè¿°å€å¡Šï¼šå€‹è‚¡ç›¸é—œæè¿° -->
            <div class="mb-6">
                <label for="stockDescription" class="block text-gray-700 text-lg font-medium mb-3">å€‹è‚¡ç›¸é—œæè¿° (é¸å¡«)</label>
                <textarea id="stockDescription" rows="4" class="textarea-field resize-y" placeholder="ä¾‹å¦‚ï¼šè©²è‚¡ç¥¨çš„Kç·šåœ–é¡¯ç¤ºå¤šé ­æ’åˆ—ï¼Œæˆ–æœ‰é‡å¤§æ–°èç™¼ä½ˆã€‚"></textarea>
            </div>

            <!-- æ–‡å­—æè¿°å€å¡Šï¼šæœŸæ¬Šç›¸é—œè³‡è¨Š -->
            <div class="mb-6">
                <label for="optionDescription" class="block text-gray-700 text-lg font-medium mb-3">æœŸæ¬Šç›¸é—œè³‡è¨Šæè¿° (é¸å¡«ï¼Œä¾‹å¦‚äº¤æ˜“é‡ã€æœªå¹³å€‰åˆç´„ã€éš±å«æ³¢å‹•ç‡ç­‰)</label>
                <textarea id="optionDescription" rows="6" class="textarea-field resize-y" placeholder="ä¾‹å¦‚ï¼šæŸè¡Œæ¬Šåƒ¹çš„çœ‹æ¼²æœŸæ¬Šäº¤æ˜“é‡é¡¯è‘—å¢åŠ ï¼Œè²·è³£æ¬Šæ¯”ç‡è™•æ–¼æ­·å²ä½ä½ï¼Œéš±å«æ³¢å‹•ç‡ä¸Šå‡ã€‚æä¾›å…·é«”æ•¸å€¼æœƒæ›´æœ‰å¹«åŠ©ã€‚"></textarea>
            </div>

            <!-- é€šç”¨è³‡è¨Šä¸Šå‚³å€å¡Š -->
            <div class="mb-6">
                <label for="generalInfo" class="block text-gray-700 text-lg font-medium mb-3">å…¶ä»–é€šç”¨è³‡è¨Š (é¸å¡«ï¼Œä¾‹å¦‚åŸºæœ¬é¢æ•¸æ“šã€è²¡å ±ã€æ–°èç¨¿ç­‰)</label>
                <textarea id="generalInfo" rows="4" class="textarea-field resize-y" placeholder="ä¾‹å¦‚ï¼šå…¬å¸æœ€æ–°è²¡å ±é¡¯ç¤ºç‡Ÿæ”¶å¢é•·è¶…é æœŸï¼Œæˆ–æœ‰æ–°çš„å¸‚å ´ç›£ç®¡æ”¿ç­–å‡ºå°ã€‚"></textarea>
            </div>

            <!-- å¸‚å ´æƒ…ç·’åˆ†æå€å¡Š -->
            <div class="mb-6">
                <label for="sentimentText" class="block text-gray-700 text-lg font-medium mb-3">âœ¨å¸‚å ´æƒ…ç·’åˆ†æèˆ‡æ‘˜è¦âœ¨ (é¸å¡«ï¼Œè¼¸å…¥æ–°èã€è©•è«–ç­‰æ–‡æœ¬)</label>
                <textarea id="sentimentText" rows="6" class="textarea-field resize-y" placeholder="è²¼ä¸Šæ‚¨æƒ³åˆ†ææƒ…ç·’çš„æ–°èæ–‡ç« ã€åˆ†æå¸«å ±å‘Šæˆ–å¸‚å ´è©•è«–ã€‚"></textarea>
                <div class="flex justify-center mt-4">
                    <button id="analyzeSentimentButton" class="button-primary flex items-center justify-center" onclick="analyzeSentiment()">
                        <span id="sentimentButtonText">åˆ†æå¸‚å ´æƒ…ç·’</span>
                        <div id="sentimentLoadingAnimation" class="ml-3 hidden stock-line-animation">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <polyline points="2 18, 8 12, 16 16, 22 8" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                    </button>
                </div>
                <div id="sentimentResults" class="mt-4 text-gray-800 prose prose-lg max-w-none">
                    <!-- Sentiment analysis results will be displayed here -->
                </div>
            </div>


            <!-- åˆ†ææŒ‰éˆ• -->
            <div class="flex justify-center">
                <button id="analyzeButton" class="button-primary flex items-center justify-center" onclick="analyzeStockAndOptions()">
                    <span id="buttonText">é–‹å§‹ç¶œåˆåˆ†æ</span>
                    <!-- è‚¡åƒ¹æŠ˜ç·šåœ–æœä¸Šçš„å°å‹•ç•« -->
                    <div id="loadingAnimation" class="ml-3 hidden stock-line-animation">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <polyline points="2 18, 8 12, 16 16, 22 8" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                            <polyline points="2 18, 8 12, 16 16, 22 8" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </div>
                </button>
            </div>
        </div>

        <!-- å»ºè­°å¢åŠ è³‡æ–™å€å¡Š -->
        <div class="card p-6 sm:p-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">ğŸ’¡å¾ŒçºŒåˆ†æè³‡æ–™å»ºè­°ğŸ’¡</h2>
            <div class="flex justify-center mt-4">
                <button id="getSuggestionsButton" class="button-primary flex items-center justify-center" onclick="getSuggestionsForAdditionalData()">
                    <span id="suggestionsButtonText">ç²å–å¢å¼·åˆ†æçš„è³‡æ–™å»ºè­°</span>
                    <div id="suggestionsLoadingAnimation" class="ml-3 hidden stock-line-animation">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <polyline points="2 18, 8 12, 16 16, 22 8" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </div>
                </button>
            </div>
            <div id="suggestionResults" class="mt-4 text-gray-800 prose prose-lg max-w-none">
                <p class="text-gray-600">é»æ“Šä¸Šæ–¹æŒ‰éˆ•ï¼ŒAI å°‡æ ¹æ“šæ‚¨ç›®å‰çš„è¼¸å…¥ï¼Œå»ºè­°å¯è£œå……çš„è³‡æ–™é¡å‹ã€‚</p>
            </div>
        </div>

        <!-- é—œéµåƒ¹ä½èˆ‡æ½›åœ¨ç›®æ¨™åƒ¹æ¦‚è¦½å€å¡Š -->
        <div class="card p-6 sm:p-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">é—œéµåƒ¹ä½èˆ‡æ½›åœ¨ç›®æ¨™åƒ¹æ¦‚è¦½</h2>
            <div id="keyPricePointsResults" class="text-gray-800 prose prose-lg max-w-none">
                <p class="text-gray-600">æ­¤è™•å°‡é¡¯ç¤ºé—œéµçš„é€²å ´ã€å‡ºå ´ã€æ”¯æ’ã€é˜»åŠ›èˆ‡ç›®æ¨™åƒ¹ä½è³‡è¨Šã€‚</p>
            </div>
        </div>

        <!-- ç¶œåˆåˆ†æçµæœå€å¡Š -->
        <div class="card p-6 sm:p-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">è©³ç´°ç¶œåˆåˆ†æçµæœ</h2>
            <div id="analysisDetailsResults" class="text-gray-800 prose prose-lg max-w-none">
                <p class="text-gray-600">æ­¤è™•å°‡é¡¯ç¤ºæŠ€è¡“åˆ†æã€æœŸæ¬Šä¿¡æ¯æ•´åˆã€å¸‚å ´æƒ…ç·’ç­‰è©³ç´°å…§å®¹ã€‚</p>
            </div>
        </div>

        <!-- ç¥ç¦èªå€å¡Š -->
        <div id="finalClosingSection" class="text-center font-bold text-gray-800 text-3xl mt-8 mb-4 hidden">
            ç¥æ‚¨è³ºçš„ç¼½æ»¿ç›†æ»¿
        </div>

    </div>

    <script>
        // ç§»é™¤äº†å‰ç«¯ç¡¬ç·¨ç¢¼çš„ API_KEYï¼Œå‰ç«¯å°‡å‘¼å«å¾Œç«¯ API
        // !!! è«‹ç¢ºä¿æ‚¨çš„å¾Œç«¯ä¼ºæœå™¨é‹è¡Œåœ¨ http://localhost:3000 !!!
        // --- æ›´æ–°é» 1 ---
        const API_BASE_URL = 'https://stock-ai-backend-api.onrender.com/api'; 
        // --- æ›´æ–°é» 1 ---

        let base64Images = []; // Array to store multiple base64 images

        // é è¦½å¤šå¼µåœ–ç‰‡
        function previewMultipleImages(event) {
            const files = event.target.files;
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            imagePreviewContainer.innerHTML = ''; // æ¸…é™¤ä¹‹å‰çš„é è¦½
            base64Images = []; // æ¸…é™¤ä¹‹å‰çš„ Base64 æ•¸æ“š

            if (files.length === 0) {
                return;
            }

            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" class="preview-image" alt="Image ${index + 1}">
                        <button class="remove-image-btn" data-index="${index}">&times;</button>
                    `;
                    imagePreviewContainer.appendChild(previewItem);
                    // ç¢ºä¿ä½¿ç”¨ file.type ç²å–æº–ç¢ºçš„ MIME é¡å‹
                    const mimeType = file.type; 
                    // å°‡ base64 æ•¸æ“šå’Œæ­£ç¢ºçš„ MIME é¡å‹ä¸€èµ·å„²å­˜
                    base64Images.push({ index: index, data: e.target.result.split(',')[1], mimeType: mimeType });

                    // ç‚ºç§»é™¤æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
                    previewItem.querySelector('.remove-image-btn').onclick = function() {
                        removeImage(index, previewItem);
                    };
                };
                reader.readAsDataURL(file);
            });
        }

        // ç§»é™¤åœ–ç‰‡
        function removeImage(indexToRemove, previewItemElement) {
            // å¾ DOM ä¸­ç§»é™¤
            previewItemElement.remove();

            // å¾ base64Images é™£åˆ—ä¸­ç§»é™¤
            base64Images = base64Images.filter(item => item.index !== indexToRemove);

            // é‡æ–°ç´¢å¼•å‰©é¤˜åœ–åƒï¼ˆå¯é¸ï¼Œä½†æœ‰åŠ©æ–¼ä¿æŒä¸€è‡´æ€§ï¼‰
            // ç”±æ–¼ filter æœƒå°è‡´ç´¢å¼•ä¸é€£çºŒï¼Œé€™è£¡é‡æ–°æ˜ å°„ index
            base64Images = base64Images.map((item, newIndex) => ({
                ...item, // è¤‡è£½ç¾æœ‰å±¬æ€§
                index: newIndex // æ›´æ–°ç´¢å¼•
            }));

            // æ›´æ–°ç§»é™¤æŒ‰éˆ•ä¸Šçš„ data-index
            document.querySelectorAll('.remove-image-btn').forEach((btn, newIndex) => {
                btn.setAttribute('data-index', newIndex);
            });
        }

        // ä¸»è¦çš„è‚¡ç¥¨èˆ‡æœŸæ¬Šç¶œåˆåˆ†æåŠŸèƒ½
        async function analyzeStockAndOptions() {
            const stockDescription = document.getElementById('stockDescription').value;
            const optionDescription = document.getElementById('optionDescription').value;
            const generalInfo = document.getElementById('generalInfo').value;
            const keyPricePointsResultsDiv = document.getElementById('keyPricePointsResults'); // æ¦‚è¦½çµæœé¡¯ç¤ºå€
            const analysisDetailsResultsDiv = document.getElementById('analysisDetailsResults'); 
            const analyzeButton = document.getElementById('analyzeButton');
            const buttonText = document.getElementById('buttonText');
            const loadingAnimation = document.getElementById('loadingAnimation');
            const finalClosingSectionDiv = document.getElementById('finalClosingSection'); // ç¥ç¦èªé¡¯ç¤ºå€

            // æ¸…é™¤ä¹‹å‰çš„çµæœ
            keyPricePointsResultsDiv.innerHTML = '<p class="text-gray-600">æ­¤è™•å°‡é¡¯ç¤ºé—œéµçš„é€²å ´ã€å‡ºå ´ã€æ”¯æ’ã€é˜»åŠ›èˆ‡ç›®æ¨™åƒ¹ä½è³‡è¨Šã€‚</p>';
            analysisDetailsResultsDiv.innerHTML = '<p class="text-gray-600">æ­¤è™•å°‡é¡¯ç¤ºæŠ€è¡“åˆ†æã€æœŸæ¬Šä¿¡æ¯æ•´åˆã€å¸‚å ´æƒ…ç·’ç­‰è©³ç´°å…§å®¹ã€‚</p>';
            finalClosingSectionDiv.classList.add('hidden'); // åˆå§‹éš±è—ç¥ç¦èªå€å¡Š


            if (base64Images.length === 0 && !stockDescription && !optionDescription && !generalInfo) {
                keyPricePointsResultsDiv.innerHTML = ''; // æ¸…é™¤é è¨­æ–‡å­—
                analysisDetailsResultsDiv.innerHTML = '<p class="text-red-600 font-semibold">è«‹è‡³å°‘ä¸Šå‚³ä¸€å¼µåœ–è¡¨æˆ–è¼¸å…¥ç›¸é—œæè¿°ä»¥é€²è¡Œåˆ†æã€‚</p>';
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
            buttonText.textContent = 'åˆ†æä¸­...';
            loadingAnimation.classList.remove('hidden');
            analyzeButton.disabled = true;
            keyPricePointsResultsDiv.innerHTML = ''; // æ¸…é™¤é è¨­æ–‡å­—
            analysisDetailsResultsDiv.innerHTML = '<p class="text-gray-600 flex items-center justify-center"><div class="stock-line-animation"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><polyline points="2 18, 8 12, 16 16, 22 8" stroke="#4f46e5" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" /></svg></div> æ­£åœ¨ç¶œåˆåˆ†æï¼Œè«‹ç¨å€™...</p>';

            // æ§‹å»º AI Prompt
            let prompt = `è«‹æ ¹æ“šä»¥ä¸‹æä¾›çš„æ‰€æœ‰è³‡è¨Šï¼ˆåŒ…æ‹¬è‚¡ç¥¨ç·šåœ–ã€æœŸæ¬Šè³‡è¨Šå’Œé€šç”¨æè¿°ï¼‰ï¼Œå°è©²æ¨™çš„é€²è¡Œå…¨é¢çš„æŠ€è¡“åˆ†æèˆ‡æœªä¾†èµ°å‹¢è©•ä¼°ã€‚è«‹ç¶œåˆè€ƒé‡å„ç¨®ä¿¡æ¯ï¼Œç‰¹åˆ¥æ˜¯æœŸæ¬Šå¸‚å ´çš„æ½›åœ¨ä¿¡æ¯ã€‚è«‹ä»¥ç¹é«”ä¸­æ–‡å›æ‡‰ã€‚

---START_SUMMARY---
**åˆ†æçµæœæ¦‚è¦½ï¼šé—œéµåƒ¹ä½èˆ‡æ½›åœ¨ç›®æ¨™åƒ¹**
è«‹å°‡æœ€é‡è¦çš„é€²å ´é»ä½ã€å‡ºå ´é»ä½ï¼ˆæ­¢æé»ï¼‰ã€é—œéµæ”¯æ’ä½ã€é—œéµé˜»åŠ›ä½ï¼Œä»¥åŠé€éæŠ€è¡“åˆ†æè©•ä¼°çš„ç›®æ¨™åƒ¹ï¼ˆé‡å°æ¯å€‹ç›®æ¨™åƒ¹æä¾›æ˜ç¢ºçš„æ©Ÿç‡ç™¾åˆ†æ¯”æˆ–é«˜/ä¸­/ä½ç­‰ç´šï¼‰ä»¥**Markdown è¡¨æ ¼å½¢å¼**ï¼Œå„ªå…ˆåˆ—å‡ºæ–¼æ­¤å ±å‘Šçš„æœ€é–‹é ­éƒ¨åˆ†ã€‚å¦‚æœåœ–ä¸­ç„¡æ³•åˆ¤æ–·ç²¾ç¢ºæ•¸å€¼ï¼Œè«‹çµ¦å‡ºåˆç†å€é–“æˆ–å®šæ€§æè¿°ã€‚

| é …ç›®         | åƒ¹ä½/å€é–“ | å‚™è¨»/æ©Ÿç‡                 |
|--------------|-----------|---------------------------|
| å»ºè­°é€²å ´é»ä½ |           |                           |
| å»ºè­°å‡ºå ´é»ä½ |           | (æ­¢æé»)                  |
| ä¸»è¦æ”¯æ’ä½   |           |                           |
| ä¸»è¦é˜»åŠ›ä½   |           |                           |
| ç›®æ¨™åƒ¹ 1     |           | å¯èƒ½æ©Ÿç‡ï¼š                |
| ç›®æ¨™åƒ¹ 2     |           | å¯èƒ½æ©Ÿç‡ï¼š                |
| ç›®æ¨™åƒ¹ 3     |           | å¯èƒ½æ©Ÿç‡ï¼š                |
---END_SUMMARY---

---START_DETAILS---
**è©³ç´°ç¶œåˆåˆ†æ**
è«‹åœ¨ä¸Šè¿°ã€Œåˆ†æçµæœæ¦‚è¦½ã€ä¹‹å¾Œï¼Œæä¾›è©³ç´°çš„ç¶œåˆè©•ä¼°ã€‚å…§å®¹è«‹åŸºæ–¼æ‚¨æä¾›çš„PDFå…§å®¹ä»¥åŠæœŸæ¬Šç›¸é—œçŸ¥è­˜ï¼ŒåŒ…å«ä½†ä¸é™æ–¼ä»¥ä¸‹é …ç›®ï¼š

-   **å¸‚å ´æƒ…ç·’èˆ‡çŸ¥æƒ…äº¤æ˜“è€…æ´»å‹•è©•ä¼°**
-   **æœŸæ¬Šä¿¡æ¯å°è‚¡ç¥¨èµ°å‹¢çš„æ½›åœ¨å½±éŸ¿**
-   **åœ–è¡¨æ¨¡å¼è­˜åˆ¥è©³è¿°**
-   **æŠ€è¡“æŒ‡æ¨™åˆ†æè©³è¿°**
-   **ç¸½çµèˆ‡é¢¨éšªæç¤º**
---END_DETAILS---
`; 

            if (stockDescription) {
                prompt += `\n**ä½¿ç”¨è€…æä¾›çš„å€‹è‚¡ç›¸é—œæè¿°ï¼š**\n${stockDescription}\n`;
            }
            if (optionDescription) {
                prompt += `\n**ä½¿ç”¨è€…æä¾›çš„æœŸæ¬Šç›¸é—œè³‡è¨Šæè¿°ï¼š**\n${optionDescription}\n`;
            }
            if (generalInfo) {
                prompt += `\n**ä½¿ç”¨è€…æä¾›çš„å…¶ä»–é€šç”¨è³‡è¨Šï¼š**\n${generalInfo}\n`;
            }
            prompt += `\n**è«‹å‹™å¿…åš´æ ¼éµå¾ªä»¥ä¸Šè¼¸å‡ºæ ¼å¼ï¼Œä½¿ç”¨ ---START_SUMMARY--- å’Œ ---END_SUMMARY--- æ¨™è¨˜ä¾†åŒ…åœæ¦‚è¦½éƒ¨åˆ†ï¼Œä¸¦ä½¿ç”¨ ---START_DETAILS--- å’Œ ---END_DETAILS--- æ¨™è¨˜ä¾†åŒ…åœè©³ç´°åˆ†æéƒ¨åˆ†ã€‚**
**åœ¨ ---END_DETAILS--- æ¨™è¨˜ä¹‹å¾Œï¼Œè«‹ä¸è¦è¼¸å‡ºä»»ä½•å…§å®¹ã€‚æˆ‘å°‡åœ¨å‰ç«¯ç›´æ¥é¡¯ç¤ºç¥ç¦èªã€‚**`; // æŒ‡ç¤ºAIä¸è¦è¼¸å‡ºç¥ç¦èª

            let payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: prompt }] 
                }],
            };

            base64Images.forEach(img => {
                payload.contents[0].parts.push({ 
                    inlineData: {
                        mimeType: img.mimeType, 
                        data: img.data
                    }
                });
            });

            console.log('--- Debug: Sending Payload ---');
            console.log('Payload contents:', JSON.stringify(payload.contents, null, 2));

            try {
                const proxyApiUrl = `${API_BASE_URL}/gemini`; 

                const response = await fetch(proxyApiUrl, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log('--- Debug: Raw API Response (è‚¡ç¥¨èˆ‡æœŸæ¬Šç¶œåˆåˆ†æ) ---');
                console.log('Raw Result:', JSON.stringify(result, null, 2)); 

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const fullText = result.candidates[0].content.parts[0].text;
                    console.log('--- Debug: Full Text from AI ---');
                    console.log('Full Text:', fullText);

                    const summaryMatch = fullText.match(/---START_SUMMARY---([\s\S]*?)---END_SUMMARY---/);
                    let summaryContent = summaryMatch && summaryMatch[1] ? summaryMatch[1].trim() : '';
                    console.log('--- Debug: Extracted Summary Content ---');
                    console.log('Summary Content (raw):', summaryMatch ? summaryMatch[1] : 'No Match');
                    console.log('Summary Content (trimmed):', summaryContent);

                    if (!summaryContent) {
                        summaryContent = '<p class="text-red-600 font-semibold">æœªèƒ½ç²å–æ¦‚è¦½è³‡è¨Šï¼Œè«‹å˜—è©¦é‡æ–°åˆ†ææˆ–æä¾›æ›´æ¸…æ™°çš„è¼¸å…¥ã€‚</p>';
                    }
                    try {
                        keyPricePointsResultsDiv.innerHTML = `<div class="p-4 bg-gray-50 rounded-lg">${marked.parse(summaryContent)}</div>`;
                        console.log('--- Debug: Summary HTML rendered ---');
                    } catch (markedError) {
                        console.error('Error rendering summary Markdown:', markedError);
                        keyPricePointsResultsDiv.innerHTML = `<p class="text-red-600 font-semibold">æ¦‚è¦½è§£æå¤±æ•—ï¼š${markedError.message}ã€‚è«‹æª¢æŸ¥AIå›æ‡‰æ ¼å¼ã€‚</p>`;
                    }

                    const detailsStartIndex = fullText.indexOf('---START_DETAILS---');
                    const detailsEndIndex = fullText.indexOf('---END_DETAILS---', detailsStartIndex);
                    let detailsContent = '';

                    if (detailsStartIndex !== -1 && detailsEndIndex !== -1) {
                        detailsContent = fullText.substring(detailsStartIndex + '---START_DETAILS---'.length, detailsEndIndex).trim();
                    } else if (detailsStartIndex !== -1) {
                        detailsContent = fullText.substring(detailsStartIndex + '---START_DETAILS---'.length).trim();
                    }
                    console.log('--- Debug: Extracted Details Content ---');
                    console.log('Details Content (raw):', (detailsStartIndex !== -1) ? fullText.substring(detailsStartIndex + '---START_DETAILS---'.length, detailsEndIndex !== -1 ? detailsEndIndex : fullText.length) : 'No Match');
                    console.log('Details Content (trimmed):', detailsContent);


                    if (!detailsContent) {
                        detailsContent = '<p class="text-red-600 font-semibold">æœªèƒ½ç²å–è©³ç´°åˆ†æï¼Œè«‹å˜—è©¦é‡æ–°åˆ†ææˆ–æä¾›æ›´æ¸…æ™°çš„è¼¸å…¥ã€‚</p>';
                    }
                    try {
                        analysisDetailsResultsDiv.innerHTML = `<div class="p-4 bg-gray-50 rounded-lg">${marked.parse(detailsContent)}</div>`;
                        console.log('--- Debug: Details HTML rendered ---');
                    } catch (markedError) {
                        console.error('Error rendering details Markdown:', markedError);
                        analysisDetailsResultsDiv.innerHTML = `<p class="text-red-600 font-semibold">è©³ç´°åˆ†æè§£æå¤±æ•—ï¼š${markedError.message}ã€‚è«‹æª¢æŸ¥AIå›æ‡‰æ ¼å¼ã€‚</p>`;
                    }

                    finalClosingSectionDiv.classList.remove('hidden');

                } else {
                    let errorMessage = 'åˆ†æå¤±æ•—ï¼šAI å›æ‡‰çµæ§‹ä¸ç¬¦é æœŸæˆ–ç„¡å…§å®¹ã€‚';
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].finishReason) {
                        errorMessage += `çµæŸåŸå› : ${result.candidates[0].finishReason}.`;
                    } else if (result.error && result.error.message) {
                        errorMessage += `API éŒ¯èª¤è¨Šæ¯: ${result.error.message}.`;
                    }
                    errorMessage += `è«‹æª¢æŸ¥åœ–ç‰‡æ¸…æ™°åº¦åŠæè¿°ã€‚è©³ç´°å›æ‡‰è«‹æŸ¥çœ‹æ§åˆ¶å°ã€‚`;

                    keyPricePointsResultsDiv.innerHTML = ''; 
                    analysisDetailsResultsDiv.innerHTML = `<p class="text-red-600 font-semibold">${errorMessage}</p>`;
                    finalClosingSectionDiv.classList.add('hidden'); 
                    console.error("AI Response structure unexpected or error:", result); 
                }

            } catch (error) {
                console.error('åˆ†æå‡ºéŒ¯:', error); 
                keyPricePointsResultsDiv.innerHTML = ''; 
                analysisDetailsResultsDiv.innerHTML = `<p class="text-red-600 font-semibold">åˆ†æéç¨‹ä¸­ç™¼ç”Ÿç¶²è·¯æˆ–å…§éƒ¨éŒ¯èª¤: ${error.message}ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚</p>`;
                finalClosingSectionDiv.classList.add('hidden'); 
            } finally {
                buttonText.textContent = 'é–‹å§‹ç¶œåˆåˆ†æ';
                loadingAnimation.classList.add('hidden'); 
                analyzeButton.disabled = false;
            }
        }

        // æ–°å¢çš„å¸‚å ´æƒ…ç·’åˆ†æåŠŸèƒ½
        async function analyzeSentiment() {
            const sentimentText = document.getElementById('sentimentText').value;
            const sentimentResultsDiv = document.getElementById('sentimentResults');
            const sentimentButtonText = document.getElementById('sentimentButtonText');
            const sentimentLoadingAnimation = document.getElementById('sentimentLoadingAnimation');
            const analyzeSentimentButton = document.getElementById('analyzeSentimentButton');

            if (!sentimentText) {
                sentimentResultsDiv.innerHTML = '<p class="text-red-600 font-semibold">è«‹è¼¸å…¥æ‚¨æƒ³åˆ†ææƒ…ç·’çš„æ–‡æœ¬ã€‚</p>';
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
            sentimentButtonText.textContent = 'åˆ†æä¸­...';
            sentimentLoadingAnimation.classList.remove('hidden');
            analyzeSentimentButton.disabled = true;
            sentimentResultsDiv.innerHTML = '<p class="text-gray-600 flex items-center justify-center"><div class="stock-line-animation"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><polyline points="2 18, 8 12, 16 16, 22 8" stroke="#4f46e5" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" /></svg></div> æ­£åœ¨åˆ†æå¸‚å ´æƒ…ç·’ï¼Œè«‹ç¨å€™...</p>';

            const sentimentPrompt = `è«‹åˆ†æä»¥ä¸‹æ–‡æœ¬ï¼Œæå–å…¶ä¸»è¦è§€é»ï¼Œåˆ¤æ–·æ•´é«”å¸‚å ´æƒ…ç·’ï¼ˆçœ‹æ¼²ã€çœ‹è·Œæˆ–ä¸­ç«‹ï¼‰ï¼Œä¸¦è­˜åˆ¥å…¶ä¸­æåŠçš„ä»»ä½•æ½›åœ¨å¸‚å ´é©…å‹•å› ç´ æˆ–é¢¨éšªã€‚è«‹ä»¥ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸¦ä»¥**æ¢åˆ—å¼æ ¼å¼**æä¾›åˆ†æçµæœï¼Œå…§å®¹è«‹ç°¡æ½”ã€‚

æ–‡æœ¬å…§å®¹ï¼š
${sentimentText}`;

            try {
                const payload = {
                    contents: [{
                        role: "user",
                        parts: [{ text: sentimentPrompt }]
                    }],
                };
                const proxyApiUrl = `${API_BASE_URL}/gemini`; 

                const response = await fetch(proxyApiUrl, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log('Sentiment API Response (å¸‚å ´æƒ…ç·’åˆ†æ):', JSON.stringify(result, null, 2)); 

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    sentimentResultsDiv.innerHTML = `<div class="p-4 bg-gray-50 rounded-lg">${marked.parse(text)}</div>`;
                } else {
                    let errorMessage = 'æƒ…ç·’åˆ†æå¤±æ•—ï¼šAI å›æ‡‰çµæ§‹ä¸ç¬¦é æœŸæˆ–ç„¡å…§å®¹ã€‚';
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].finishReason) {
                        errorMessage += `çµæŸåŸå› : ${result.candidates[0].finishReason}.`;
                    } else if (result.error && result.error.message) {
                        errorMessage += `API éŒ¯èª¤è¨Šæ¯: ${result.error.message}.`;
                    }
                    errorMessage += `è«‹ç¢ºä¿è¼¸å…¥æ–‡æœ¬æ¸…æ™°ã€‚è©³ç´°å›æ‡‰è«‹æŸ¥çœ‹æ§åˆ¶å°ã€‚`;

                    sentimentResultsDiv.innerHTML = `<p class="text-red-600 font-semibold">${errorMessage}</p>`;
                    console.error("AI Sentiment Response structure unexpected or error:", result); 
                }

            } catch (error) {
                console.error('æƒ…ç·’åˆ†æå‡ºéŒ¯:', error); 
                sentimentResultsDiv.innerHTML = `<p class="text-red-600 font-semibold">æƒ…ç·’åˆ†æéç¨‹ä¸­ç™¼ç”Ÿç¶²è·¯æˆ–å…§éƒ¨éŒ¯èª¤: ${error.message}ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚</p>`;
            } finally {
                sentimentButtonText.textContent = 'åˆ†æå¸‚å ´æƒ…ç·’';
                sentimentLoadingAnimation.classList.add('hidden');
                analyzeSentimentButton.disabled = false;
            }
        }

        // æ–°å¢åŠŸèƒ½ï¼šç²å–å»ºè­°æä¾›æ›´å¤šè³‡æ–™çš„é¡å‹
        async function getSuggestionsForAdditionalData() {
            const stockDescription = document.getElementById('stockDescription').value;
            const optionDescription = document.getElementById('optionDescription').value;
            const generalInfo = document.getElementById('generalInfo').value;
            const suggestionResultsDiv = document.getElementById('suggestionResults');
            const suggestDataButtonText = document.getElementById('suggestionsButtonText');
            const suggestDataLoadingAnimation = document.getElementById('suggestionsLoadingAnimation');
            const suggestDataButton = document.getElementById('getSuggestionsButton');

            // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
            suggestDataButtonText.textContent = 'ç²å–å»ºè­°ä¸­...';
            suggestDataLoadingAnimation.classList.remove('hidden');
            suggestDataButton.disabled = true;
            suggestionResultsDiv.innerHTML = '<p class="text-gray-600 flex items-center justify-center"><div class="stock-line-animation"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><polyline points="2 18, 8 12, 16 16, 22 8" stroke="#4f46e5" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" /></svg></div> æ­£åœ¨ç²å–è³‡æ–™å»ºè­°ï¼Œè«‹ç¨å€™...</p>';

            let prompt = `è«‹æ ¹æ“šä»¥ä¸‹å·²æä¾›çš„è‚¡ç¥¨ç·šåœ–ã€å€‹è‚¡æè¿°ã€æœŸæ¬Šè³‡è¨Šå’Œé€šç”¨è³‡è¨Šçš„æ¦‚æ³ï¼Œç°¡æ½”åœ°åˆ—å‡º 3 åˆ° 5 é …æ‚¨å¯ä»¥é¡å¤–æä¾›çš„é—œéµè³‡æ–™é¡å‹ï¼Œä»¥å¹«åŠ©æˆ‘ï¼ˆä½œç‚º AIï¼‰é¡¯è‘—æé«˜åˆ†ææº–ç¢ºåº¦å’Œæ·±åº¦ã€‚è«‹ä»¥ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸¦ä»¥**æ¢åˆ—å¼æ ¼å¼**æä¾›ï¼Œæ¯é …å»ºè­°ç°¡è¦èªªæ˜å…¶æ½›åœ¨åƒ¹å€¼ã€‚

å·²æä¾›çš„è³‡è¨Šæ¦‚æ³ï¼š
- æ˜¯å¦æä¾›äº†è‚¡ç¥¨ç·šåœ–ï¼š${base64Images.length > 0 ? 'æ˜¯' : 'å¦'}
- æ˜¯å¦æä¾›äº†å€‹è‚¡ç›¸é—œæè¿°ï¼š${stockDescription ? 'æ˜¯' : 'å¦'}
- æ˜¯å¦æä¾›äº†æœŸæ¬Šç›¸é—œè³‡è¨Šæè¿°ï¼š${optionDescription ? 'æ˜¯' : 'å¦'}
- æ˜¯å¦æä¾›äº†å…¶ä»–é€šç”¨è³‡è¨Šï¼š${generalInfo ? 'æ˜¯' : 'å¦'}

è«‹åƒ…åˆ—å‡ºæœ€é‡è¦çš„ 3 åˆ° 5 é …å»ºè­°ã€‚`;

            const parts = [{ text: prompt }];
            base64Images.forEach(img => {
                parts.push({
                    inlineData: {
                        mimeType: img.mimeType, 
                        data: img.data
                    }
                });
            });


            try {
                const payload = {
                    contents: [{
                        role: "user",
                        parts: parts
                    }],
                };
                const proxyApiUrl = `${API_BASE_URL}/gemini`; 

                const response = await fetch(proxyApiUrl, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log('Suggestion API Response (è³‡æ–™å»ºè­°):', JSON.stringify(result, null, 2));

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    suggestionResultsDiv.innerHTML = `<div class="p-4 bg-gray-50 rounded-lg">${marked.parse(text)}</div>`;
                } else {
                     let errorMessage = 'æœªèƒ½ç²å–è³‡æ–™å»ºè­°ï¼šAI å›æ‡‰çµæ§‹ä¸ç¬¦é æœŸæˆ–ç„¡å…§å®¹ã€‚';
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].finishReason) {
                        errorMessage += `çµæŸåŸå› : ${result.candidates[0].finishReason}.`;
                    } else if (result.error && result.error.message) {
                        errorMessage += `API éŒ¯èª¤è¨Šæ¯: ${result.error.message}.`;
                    }
                    errorMessage += `è«‹ç¢ºä¿è¼¸å…¥æ–‡æœ¬æ¸…æ™°ã€‚è©³ç´°å›æ‡‰è«‹æŸ¥çœ‹æ§åˆ¶å°ã€‚`;
                    suggestionResultsDiv.innerHTML = `<p class="text-red-600 font-semibold">${errorMessage}</p>`;
                    console.error("AI Suggestion Response structure unexpected or error:", result);
                }

            } catch (error) {
                console.error('ç²å–è³‡æ–™å»ºè­°å‡ºéŒ¯:', error);
                suggestionResultsDiv.innerHTML = `<p class="text-red-600 font-semibold">ç²å–è³‡æ–™å»ºè­°éç¨‹ä¸­ç™¼ç”Ÿç¶²è·¯æˆ–å…§éƒ¨éŒ¯èª¤: ${error.message}ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚</p>`;
            } finally {
                suggestDataButtonText.textContent = 'è©¢å•å¯å¢åŠ çš„è³‡æ–™é¡å‹';
                suggestDataLoadingAnimation.classList.add('hidden');
                suggestDataButton.disabled = false;
            }
        }


        // Markdown æ¸²æŸ“å™¨ (ç°¡æ˜“ç‰ˆï¼Œè™•ç†å¸¸è¦‹çš„ Markdown æ ¼å¼)
        const marked = {
            parse: function(markdown) {
                let html = markdown;

                // è™•ç†ç²—é«”
                html = html.replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>');

                // è™•ç†æ¨™é¡Œ
                html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

                // è™•ç†ç„¡åºåˆ—è¡¨
                html = html.replace(/^\s*[\*-] (.*$)/gim, '<li>$1</li>');

                // å°‡é€£çºŒçš„åˆ—è¡¨é …ç›®åŒ…è£åœ¨ <ul> ä¸­
                const listPattern = /(<li>.*?<\/li>(\s*<li>.*?<\/li>)*)/gs;
                html = html.replace(listPattern, '<ul>$1</ul>');

                // è™•ç†æ®µè½ (é¿å…å°‡å·²è™•ç†çš„æ¨™ç±¤åŒ…è£åœ¨ <p> ä¸­)
                html = html.split('\n\n').map(paragraph => {
                    if (paragraph.match(/<h[1-3]>|<ul|<li/i)) {
                        return paragraph;
                    }
                    return `<p>${paragraph.trim()}</p>`;
                }).join('');

                // ç§»é™¤ç”±æ–¼åˆ†æ®µè™•ç†å¯èƒ½ç”¢ç”Ÿçš„ç©º <p> æ¨™ç±¤
                html = html.replace(/<p>\s*<\/p>/g, '');
                // è™•ç†å¯èƒ½æ®˜ç•™çš„æ›è¡Œç¬¦
                html = html.replace(/(\r\n|\r|\n)/g, '<br>');

                // Add basic table parsing
                const tableRegex = /\|(.+)\|\n\|(?:\s*[-:]+\s*\|)+\n((?:\|.*\|\n)*)/g;
                html = html.replace(tableRegex, (match, headerRow, body) => {
                    const headers = headerRow.split('|').filter(h => h.trim() !== '').map(h => `<th>${h.trim()}</th>`).join('');
                    const rows = body.split('\n').filter(r => r.trim() !== '').map(row => {
                        const cells = row.split('|').filter(c => c.trim() !== '').map(c => `<td>${c.trim()}</td>`).join('');
                        return `<tr>${cells}</tr>`;
                    }).join('');
                    return `<table><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
                });


                return html;
            }
        };

        // ç¢ºä¿ marked.js å¾ CDN è¼‰å…¥ï¼Œä¸¦åœ¨è¼‰å…¥å®Œæˆå¾Œä½¿ç”¨å…¶åŠŸèƒ½æ›´å¼·å¤§çš„ parse æ–¹æ³•
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
        script.onload = () => {
            if (window.marked) {
                marked.parse = window.marked.parse;
            }
        };
        document.head.appendChild(script);

    </script>
</body>
</html>
