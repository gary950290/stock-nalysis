<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成問AI的股票與期權綜合分析</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px; /* Add space between cards */
        }
        .button-primary {
            background-color: #4f46e5;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .button-primary:hover {
            background-color: #4338ca;
        }
        .input-field, .textarea-field {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 10px 14px;
            width: 100%;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-field:focus, .textarea-field:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .file-input-label {
            display: inline-block;
            background-color: #e0e7ff;
            color: #4f46e5;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        .file-input-label:hover {
            background-color: #c7d2fe;
        }
        .preview-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-height: 200px; /* Limit height for multiple images */
            object-fit: contain; /* Ensure image fits without distortion */
        }
        .image-preview-item {
            position: relative;
            margin: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
        }
        .remove-image-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            z-index: 10;
            transition: background-color 0.2s;
        }
        .remove-image-btn:hover {
            background-color: #dc2626;
        }

        /* Stock Line Animation */
        .stock-line-animation {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }
        .stock-line-animation svg {
            width: 24px;
            height: 24px;
        }
        .stock-line-animation polyline {
            stroke: #ffffff;
            stroke-width: 2.5;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            animation: floatUpAndDown 1.5s ease-in-out infinite;
        }
        @keyframes floatUpAndDown {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        /* Markdown table styling */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
            margin-bottom: 1em;
        }
        .prose th, .prose td {
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            text-align: left;
        }
        .prose th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        /* Ensure text wraps within prose blocks */
        .prose {
            word-break: break-word; /* For older browsers */
            overflow-wrap: break-word; /* Standard property */
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div class="container mx-auto">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-8 mt-4">成問AI的股票與期權綜合分析</h1>

        <div class="card p-6 sm:p-8 mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">上傳資訊與輸入描述</h2>

            <!-- 圖片上傳區塊 (支援多圖) -->
            <div class="mb-6">
                <label for="chartInputs" class="block text-gray-700 text-lg font-medium mb-3">上傳圖表 (可多選，支援 PNG/JPG/JPEG)</label>
                <input type="file" id="chartInputs" accept="image/*" multiple class="hidden" onchange="previewMultipleImages(event)">
                <label for="chartInputs" class="file-input-label">選擇圖片檔案</label>
                <div id="imagePreviewContainer" class="flex flex-wrap mt-4">
                    <!-- Image previews will be dynamically added here -->
                </div>
            </div>

            <!-- 文字描述區塊：個股相關描述 -->
            <div class="mb-6">
                <label for="stockDescription" class="block text-gray-700 text-lg font-medium mb-3">個股相關描述 (選填)</label>
                <textarea id="stockDescription" rows="4" class="textarea-field resize-y" placeholder="例如：該股票的K線圖顯示多頭排列，或有重大新聞發佈。"></textarea>
            </div>

            <!-- 文字描述區塊：期權相關資訊 -->
            <div class="mb-6">
                <label for="optionDescription" class="block text-gray-700 text-lg font-medium mb-3">期權相關資訊描述 (選填，例如交易量、未平倉合約、隱含波動率等)</label>
                <textarea id="optionDescription" rows="6" class="textarea-field resize-y" placeholder="例如：某行權價的看漲期權交易量顯著增加，買賣權比率處於歷史低位，隱含波動率上升。提供具體數值會更有幫助。"></textarea>
            </div>

            <!-- 通用資訊上傳區塊 -->
            <div class="mb-6">
                <label for="generalInfo" class="block text-gray-700 text-lg font-medium mb-3">其他通用資訊 (選填，例如基本面數據、財報、新聞稿等)</label>
                <textarea id="generalInfo" rows="4" class="textarea-field resize-y" placeholder="例如：公司最新財報顯示營收增長超預期，或有新的市場監管政策出台。"></textarea>
            </div>

            <!-- 市場情緒分析區塊 -->
            <div class="mb-6">
                <label for="sentimentText" class="block text-gray-700 text-lg font-medium mb-3">✨市場情緒分析與摘要✨ (選填，輸入新聞、評論等文本)</label>
                <textarea id="sentimentText" rows="6" class="textarea-field resize-y" placeholder="貼上您想分析情緒的新聞文章、分析師報告或市場評論。"></textarea>
                <div class="flex justify-center mt-4">
                    <button id="analyzeSentimentButton" class="button-primary flex items-center justify-center" onclick="analyzeSentiment()">
                        <span id="sentimentButtonText">分析市場情緒</span>
                        <div id="sentimentLoadingAnimation" class="ml-3 hidden stock-line-animation">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <polyline points="2 18, 8 12, 16 16, 22 8" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                    </button>
                </div>
                <div id="sentimentResults" class="mt-4 text-gray-800 prose prose-lg max-w-none">
                    <!-- Sentiment analysis results will be displayed here -->
                </div>
            </div>


            <!-- 分析按鈕 -->
            <div class="flex justify-center">
                <button id="analyzeButton" class="button-primary flex items-center justify-center" onclick="analyzeStockAndOptions()">
                    <span id="buttonText">開始綜合分析</span>
                    <!-- 股價折線圖朝上的小動畫 -->
                    <div id="loadingAnimation" class="ml-3 hidden stock-line-animation">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <polyline points="2 18, 8 12, 16 16, 22 8" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </div>
                </button>
            </div>
        </div>

        <!-- 建議增加資料區塊 -->
        <div class="card p-6 sm:p-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">💡後續分析資料建議💡</h2>
            <div class="flex justify-center mt-4">
                <button id="getSuggestionsButton" class="button-primary flex items-center justify-center" onclick="getSuggestionsForAdditionalData()">
                    <span id="suggestionsButtonText">獲取增強分析的資料建議</span>
                    <div id="suggestionsLoadingAnimation" class="ml-3 hidden stock-line-animation">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <polyline points="2 18, 8 12, 16 16, 22 8" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                    </button>
                </div>
                <div id="suggestionResults" class="mt-4 text-gray-800 prose prose-lg max-w-none">
                <p class="text-gray-600">點擊上方按鈕，AI 將根據您目前的輸入，建議可補充的資料類型。</p>
            </div>
        </div>

        <!-- 關鍵價位與潛在目標價概覽區塊 -->
        <div class="card p-6 sm:p-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">關鍵價位與潛在目標價概覽</h2>
            <div id="keyPricePointsResults" class="text-gray-800 prose prose-lg max-w-none">
                <p class="text-gray-600">此處將顯示關鍵的進場、出場、支撐、阻力與目標價位資訊。</p>
            </div>
        </div>

        <!-- 綜合分析結果區塊 -->
        <div class="card p-6 sm:p-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">詳細綜合分析結果</h2>
            <div id="analysisDetailsResults" class="text-gray-800 prose prose-lg max-w-none">
                <p class="text-gray-600">此處將顯示技術分析、期權信息整合、市場情緒等詳細內容。</p>
            </div>
        </div>

        <!-- 提問區塊 -->
        <div class="card p-6 sm:p-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">對分析結果提問 (進一步分析)</h2>
            <div class="mb-6">
                <label for="followUpQuestionText" class="block text-gray-700 text-lg font-medium mb-3">您的問題</label>
                <textarea id="followUpQuestionText" rows="4" class="textarea-field resize-y" placeholder="例如：您可以進一步解釋期權數據對未來走勢的影響嗎？或者，如果市場發生X事件，分析結果會如何變化？"></textarea>
                <div class="flex justify-center mt-4">
                    <button id="askFollowUpButton" class="button-primary flex items-center justify-center" onclick="askFollowUpQuestion()">
                        <span id="followUpButtonText">提問</span>
                        <div id="followUpLoadingAnimation" class="ml-3 hidden stock-line-animation">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <polyline points="2 18, 8 12, 16 16, 22 8" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                    </button>
                </div>
                <div id="followUpResults" class="mt-4 text-gray-800 prose prose-lg max-w-none">
                    <p class="text-gray-600">此處將顯示您對分析結果的進一步提問的回答。</p>
                </div>
            </div>
        </div>


        <!-- 祝福語區塊 -->
        <div id="finalClosingSection" class="text-center font-bold text-gray-800 text-3xl mt-8 mb-4 hidden">
            祝您賺的缽滿盆滿
        </div>

        <!-- 技術分析參考資料區塊 - 此區塊已隱藏，但內容會提供給 AI 進行分析 -->
        <div id="technicalAnalysisContent" class="hidden">
            <h3>道氏理論 (Dow Theory)</h3>
            <ul>
                <li>市場有三種運動：主要運動（Primary Movement，持續一年或更久）、次級折返（Secondary Reaction，持續三週到數月，回撤主要趨勢的33%-66%）、短期波動（Minor Movement，持續數小時到一個月）。</li>
                <li>市場趨勢有三個階段：累積階段、公眾參與階段、派發階段。</li>
                <li>股票市場會消化所有新聞。</li>
                <li>股票市場平均指數必須相互確認。</li>
                <li>成交量必須確認趨勢。</li>
                <li>趨勢會持續，直到明確的信號證明其已結束。</li>
            </ul>

            <h3>K線圖基礎 (Candlestick Chart Basics)</h3>
            <ul>
                <li>K線圖顯示開盤價、最高價、最低價和收盤價。</li>
                <li>**陽線/白K線 (Bullish/White Candlestick)**: 收盤價高於開盤價，表示買方壓力。</li>
                <li>**陰線/黑K線 (Bearish/Black Candlestick)**: 收盤價低於開盤價，表示賣方壓力。</li>
                <li>**影線 (Shadow/Wick/Tail)**: 實體之外的細線，表示該時間段內的最高價和最低價。</li>
            </ul>

            <h3>常見K線圖型態 (Common Candlestick Patterns)</h3>
            <h4>單一K線型態 (One-Candle Patterns)</h4>
            <ul>
                <li>**錘形線 (Hammer)**: 
                    <ul>
                        <li>特徵：長下影線（至少實體兩倍長）、小實體（位於交易區間上端）、幾乎無上影線。出現在下跌趨勢中，預示潛在看漲反轉。</li>
                        <li>心理：空頭無法維持控制，多頭開始介入。</li>
                        <li>確認：次日出現強勁的看漲陽線。</li>
                    </ul>
                </li>
                <li>**上吊線 (Hanging Man)**: 
                    <ul>
                        <li>特徵：與錘形線類似，但出現在上升趨勢中，預示潛在看跌反轉。</li>
                        <li>心理：買方失去動力，賣方可能接管。</li>
                        <li>確認：次日出現下跌的陰線。</li>
                    </ul>
                </li>
                <li>**倒錘形線 (Inverted Hammer)**: 
                    <ul>
                        <li>特徵：長上影線（至少實體兩倍長）、小實體（位於交易區間下端）、幾乎無下影線。出現在下跌趨勢中，預示潛在看漲反轉。</li>
                        <li>心理：多頭試圖推高價格但未能維持，但次日若多頭強勁，則可能反轉。</li>
                    </ul>
                </li>
                <li>**流星線 (Shooting Star)**: 
                    <ul>
                        <li>特徵：與倒錘形線類似，但出現在上升趨勢中，預示潛在看跌反轉。</li>
                        <li>心理：買方在開盤後將價格推高，但收盤前賣方強勢介入，將價格壓回。</li>
                    </ul>
                </li>
            </ul>
            <h4>兩根K線型態 (Two-Candle Patterns)</h4>
            <ul>
                <li>**看漲吞沒 (Bullish Engulfing)**: 
                    <ul>
                        <li>特徵：在下跌趨勢中，一根小型黑K線被一根大型白K線完全包覆。</li>
                        <li>心理：買方勢力完全壓倒賣方，趨勢可能反轉。</li>
                    </ul>
                </li>
                <li>**看跌吞沒 (Bearish Engulfing)**: 
                    <ul>
                        <li>特徵：在上升趨勢中，一根小型白K線被一根大型黑K線完全包覆。</li>
                        <li>心理：賣方勢力完全壓倒買方，趨勢可能反轉。</li>
                    </ul>
                </li>
                <li>**穿刺線 (Piercing Pattern)**: 
                    <ul>
                        <li>特徵：在下跌趨勢中，第一根為長黑K線，第二根為跳空低開的長白K線，且其收盤價深入第一根黑K線實體1/2以上。</li>
                        <li>心理：空頭勢力減弱，多頭開始反擊。</li>
                    </ul>
                </li>
                <li>**烏雲蓋頂 (Dark Cloud Cover)**: 
                    <ul>
                        <li>特徵：在上升趨勢中，第一根為長白K線，第二根為跳空高開的長黑K線，且其收盤價深入第一根白K線實體1/2以下。</li>
                        <li>心理：多頭勢力減弱，空頭開始反擊。</li>
                    </ul>
                </li>
                <li>**看漲/看跌分離 (Bullish/Bearish Separating Lines)**: 
                    <ul>
                        <li>特徵：兩根K線開盤價幾乎相等，看漲為前陰後陽，看跌為前陽後陰。</li>
                    </ul>
                </li>
                <li>**低位孕線 (Bullish Harami)**: 
                    <ul>
                        <li>特徵：在下跌趨勢中，一根大陰線後出現一根小陽線，小陽線完全被大陰線實體包覆。</li>
                    </ul>
                </li>
                <li>**高位孕線 (Bearish Harami)**: 
                    <ul>
                        <li>特徵：在上升趨勢中，一根大陽線後出現一根小陰線，小陰線完全被大陽線實體包覆。</li>
                    </ul>
                </li>
            </ul>
            <h4>三根K線型態 (Three-Candle Patterns)</h4>
            <ul>
                <li>**啟明星 (Morning Star)**: 
                    <ul>
                        <li>特徵：下跌後出現一根陰線、跳空下跌的十字線，再接著高開高走的陽線。</li>
                        <li>心理：空頭力量耗盡，多頭開始掌控。</li>
                    </ul>
                </li>
                <li>**黃昏星 (Evening Star)**: 
                    <ul>
                        <li>特徵：上升後出現一根陽線、跳空上升的十字線，再接著低開低走的陰線。</li>
                        <li>心理：多頭力量耗盡，空頭開始掌控。</li>
                    </ul>
                </li>
                <li>**紅三兵 (Three White Soldiers)**: 
                    <ul>
                        <li>特徵：連續三根陽線，實體大致相等且後兩根升幅大致相等。</li>
                    </ul>
                </li>
                <li>**三隻烏鴉 (Three Black Crows)**: 
                    <ul>
                        <li>特徵：在上升趨勢頂部盤整中，出現三根連續下跌的小陰線。</li>
                    </ul>
                </li>
                <li>**多方炮 (Three Inside Up/Down)**: 
                    <ul>
                        <li>特徵：兩根陽線中間夾一根陰線，陰線被前一根陽線孕育，也被後一根陽線吞沒。</li>
                    </ul>
                </li>
                <li>**空方炮 (Three Outside Up/Down)**: 
                    <ul>
                        <li>特徵：兩根陰線中間夾一根陽線，陽線被前一根陰線孕育，也被後一根陰線吞沒。</li>
                    </ul>
                </li>
                <li>**上升三法 (Rising Three Methods)**: 
                    <ul>
                        <li>特徵：兩根長陽線中間夾三根短陰線依次下跌，但未跌破第一根陽線開盤價，最後一根陽線收復三根短陰線跌幅。</li>
                    </ul>
                </li>
                <li>**下跌三法 (Falling Three Methods)**: 
                    <ul>
                        <li>特徵：兩根長陰線中間夾三根短陽線依次上升，但未上穿第一根陰線開盤價，最後一根陰線完成覆蓋三根短陽線升幅。</li>
                    </ul>
                </li>
            </ul>

            <h3>圖表型態 (Chart Patterns)</h3>
            <h4>趨勢延續型態 (Continuation Patterns)</h4>
            <ul>
                <li>**旗形 (Flag Pattern)**:
                    <ul>
                        <li>**看漲旗形 (Bullish Flag)**: 強勁上漲後價格在向下傾斜的通道內盤整，預示上漲趨勢恢復。成功率約75%。</li>
                        <li>**看跌旗形 (Bearish Flag)**: 強勁下跌後價格在向上傾斜的通道內盤整，預示下跌趨勢恢復。成功率約68%。</li>
                    </ul>
                </li>
                <li>**三角旗形 (Pennant Pattern)**:
                    <ul>
                        <li>**看漲三角旗形 (Bullish Pennant)**: 上漲趨勢中出現的收斂三角形，預示上漲趨勢恢復。成功率約67.8%。</li>
                        <li>**看跌三角旗形 (Bearish Pennant)**: 下跌趨勢中出現的收斂三角形，預示下跌趨勢恢復。成功率約71.3%。</li>
                    </ul>
                </li>
                <li>**矩形 (Rectangle Pattern)**:
                    <ul>
                        <li>**看漲矩形 (Bullish Rectangle)**: 上漲趨勢中價格在支撐和阻力位之間橫向盤整，預示上漲趨勢恢復。成功率約68.5%。</li>
                        <li>**看跌矩形 (Bearish Rectangle)**: 下跌趨勢中價格在支撐和阻力位之間橫向盤整，預示下跌趨勢恢復。成功率約64.7%。</li>
                    </ul>
                </li>
                <li>**楔形 (Wedge Pattern)**:
                    <ul>
                        <li>**上升楔形 (Rising Wedge)**: 看跌型態，價格在向上傾斜的收斂支撐和阻力線之間震盪。成功率約65%預測向下反轉。</li>
                        <li>**下降楔形 (Falling Wedge)**: 看漲型態，價格在向下傾斜的收斂支撐和阻力線之間震盪。成功率約70%預測向上突破。</li>
                    </ul>
                </li>
                <li>**杯柄型態 (Cup and Handle)**: 看漲延續型態，價格形成U形杯狀後再出現一個較小的「柄」形修正，預示價格將大幅上漲。成功率81%。</li>
            </ul>
            <h4>趨勢反轉型態 (Reversal Patterns)</h4>
            <ul>
                <li>**頭肩型態 (Head and Shoulders)**: 
                    <ul>
                        <li>**頭肩頂 (Head and Shoulders Top)**: 看跌反轉型態，在上升趨勢頂部形成，由一個較高的頭部和兩側較低的肩部組成。成功率約65%-93% (配合成交量)。</li>
                        <li>**頭肩底 (Inverse Head and Shoulders)**: 看漲反轉型態，在下跌趨勢底部形成，由一個較低的頭部和兩側較高的肩部組成。成功率約75%。</li>
                    </ul>
                </li>
                <li>**雙重頂/底 (Double Top/Bottom)**:
                    <ul>
                        <li>**雙重頂 (Double Top)**: M形看跌反轉型態，兩個價格峰值約在同一水平，預示趨勢向下。成功率約70% (配合MACD)。</li>
                        <li>**雙重底 (Double Bottom)**: W形看漲反轉型態，兩個價格谷底約在同一水平，預示趨勢向上。成功率75%。</li>
                    </ul>
                </li>
                <li>**三重頂/底 (Triple Top/Bottom)**:
                    <ul>
                        <li>**三重頂 (Triple Top)**: 看跌反轉型態，價格三次測試同一阻力位失敗。成功率約70%。</li>
                        <li>**三重底 (Triple Bottom)**: 看漲反轉型態，價格三次測試同一支撐位成功。成功率約72%。</li>
                    </ul>
                </li>
                <li>**圓弧頂/底 (Rounding Top/Bottom)**: 緩慢而漸進的趨勢反轉型態，圓弧底為看漲，圓弧頂為看跌。</li>
                <li>**突漲止跌/突跌反漲 (Bump and Run Reversal - BARR)**: 反轉型態，價格在過度投機後快速上漲或下跌，隨後反轉。成功率85%。</li>
                <li>**龍型態 (Dragon Pattern) / 倒龍型態 (Inverse Dragon Pattern)**: 類似雙重底/頂，但有特定的「頭部」和「駝峰」結構，通常在市場底部形成。</li>
            </ul>

            <h3>支撐與阻力 (Support and Resistance)</h3>
            <ul>
                <li>**支撐位 (Support)**: 價格下跌時難以跌破的水平。</li>
                <li>**阻力位 (Resistance)**: 價格上漲時難以突破的水平。</li>
                <li>**角色互換 (Role Reversal)**: 當支撐位被突破後，可能轉變為新的阻力位；反之亦然。</li>
                <li>通常不是單一價格，而是一個價格區間。整數價位（如10、50、100）常作為心理支撐/阻力位。</li>
            </ul>

            <h3>其他重要概念 (Other Important Concepts)</h3>
            <ul>
                <li>**趨勢線 (Trend Line)**: 連接一系列高點或低點的直線，用於判斷趨勢方向。</li>
                <li>**突破 (Breakout)**: 價格突破支撐或阻力位，通常伴隨成交量放大，預示新趨勢的開始。</li>
                <li>**假突破 (False Breakout)**: 價格短暫突破支撐或阻力位後迅速回歸原區間。</li>
                <li>**回踩/回抽 (Pullback/Throwback)**: 價格突破後，短期回測被突破的支撐/阻力位。</li>
                <li>**成交量 (Volume)**: 交易活動的量，用於確認價格趨勢和型態的有效性。</li>
                <li>**斐波那契回撤/擴展 (Fibonacci Retracement/Extension)**: 利用斐波那契數列比例來預測潛在的支撐阻力位和目標價位。主要比例為0.382, 0.5, 0.618, 0.786（回撤）和1.272, 1.618（擴展）。</li>
                <li>**技術分析假設 (Technical Analysis Assumptions)**: 市場消化一切、價格沿趨勢移動、歷史會重演。</li>
            </ul>
        </div>
        
        <!-- 市場超級週期參考資料區塊 - 此區塊已隱藏，但內容會提供給 AI 進行分析 -->
        <div id="marketSuperCyclesContent" class="hidden">
            <h3>市場中的結構性變化與超級週期：高盛首席分析師的見解</h3>
            <p>這份文件摘錄自《高盛首席分析師教你剖析超級週期：掌握進場的訊號》，提供了關於金融市場週期和長期趨勢的見解，尤其強調了「超級週期」的概念及其影響因素。</p>

            <h4>序言：週期與長期趨勢簡介</h4>
            <p>金融市場週期往往會隨著時間重複其模式，並在長期結構性趨勢的範圍內展開。歷史表明，經濟活動和實際收入可能數十年來相對平緩甚至倒退，而另一些時期則經歷持續的增長和繁榮。同樣，在金融市場中，也存在著長期時期或「超級週期」，其中整體回報受到抑制，而另一些時期則呈現出強勁的上升趨勢。當這些長期趨勢或體制發生變化時，由於投資者往往沒有為其做好準備，假設根深蒂固，因此調整適應新現實的速度往往很慢，這可能會產生重大影響。</p>

            <h5>重複的週期</h5>
            <p>週期無處不在，不僅在自然界中，在人類本性、社會、經濟以及金融市場中亦是如此。社會優先事項、政治、國際關係和經濟條件之間的複雜性和相互關聯性意味著這些週期通常存在於長期或延伸的時期中，這些時期是結構性趨勢的函數，可以為金融市場帶來截然不同的結果。</p>

            <h5>心理與金融市場超級週期</h5>
            <p>除了金融週期與經濟週期之間的關係之外，某些人類行為模式也反映並有時會放大預期的經濟狀況。投資者如何看待經濟學和基本面，對於這種組合至關重要。學術研究日益表明，冒險意願是支持性政策（例如低利率）影響週期的關鍵渠道。冒險意願和過度謹慎的時期（通常在一段時間的疲軟回報之後）是往往會放大經濟基本面對金融市場的影響並促成週期和重複模式的因素。</p>

            <h4>第一部分：結構性趨勢與市場超級週期</h4>
            <p>本節深入探討了驅動長期趨勢的因素，並將經濟活動、通貨膨脹、利率、政府債務和不平等視為超級週期的關鍵驅動因素。</p>

            <h5>股票週期及其驅動因素</h5>
            <p>歷史上，金融市場的短期週期和長期超級週期或長期趨勢中都存在模式，其中短期週期會隨之演變。儘管股票回報的長期轉變取決於普遍的宏觀經濟狀況（特別是增長與利率之間的權衡），但大多數股票市場都表現出週期性變動的趨勢，這在一定程度上與普遍的商業週期相關。</p>
            <p>一個投資週期通常包括熊市（價格下跌的時期）和牛市（股價普遍上漲或價格回報相對穩定的時期）。儘管如此，沒有兩個週期，甚至長期超級週期是完全相同的。有些比其他週期長得多，有些可能在中途被中斷，例如由於特定的衝擊或事件導致指數回到轉折點而沒有完成整個週期。</p>
            <p>股票週期通常可分為四個截然不同的階段，每個階段都由不同的因素驅動：</p>
            <ol>
                <li><strong>絕望 (Despair)</strong>：市場從高峰走向低谷的時期，也稱為熊市。這主要是由估值下降（本益比收縮）驅動的，因為市場預期並應對不斷惡化的宏觀經濟環境及其對預期收益下降的影響。</li>
                <li><strong>希望 (Hope)</strong>：一個通常較短的時期，市場從估值低谷反彈（本益比擴張）。這是在預期經濟週期即將觸底以及未來利潤增長的情況下發生的，並導致估值倍數的上升。</li>
                <li><strong>成長 (Growth)</strong>：這通常是持續時間最長的時期，收益增長推動回報。</li>
                <li><strong>樂觀 (Optimism)</strong>：週期的最後一部分，投資者變得越來越自信，甚至自滿，估值傾向於再次上升並超越收益增長，從而為下一次市場調整奠定基礎。</li>
            </ol>

            <h5>超級週期及其驅動因素</h5>
            <p>超級週期是指經濟活動和實際收入可能相對平穩甚至倒退數十年的時期，而其他時期則經歷持續的增長和繁榮。同樣，在金融市場中，也存在長期階段或超級週期，其中整體回報受到抑制，而另一些時期則呈現出強勁的上升趨勢。</p>
            <h6>經濟活動的超級週期</h6>
            <p>從歷史上看，長期經濟繁榮時期是由多種因素的重大階段性變化驅動的，這些因素包括技術進步、金融市場創新、移民和貿易增加。所有這些因素在解釋 20 世紀的增長和金融市場超級週期方面仍然是重要因素。</p>
            <h6>通貨膨脹的超級週期</h6>
            <p>從金融市場的角度來看，兩個主要變數最重要：增長和通貨膨脹。儘管有證據表明經濟增長和收縮存在長波，但通貨膨脹數據也呈週期性。通貨膨脹像經濟增長一樣，並沒有直線增長，而是隨著時間經歷了各種結構性事件。</p>
            <h6>利率的超級週期</h6>
            <p>利率的歷史同樣令人驚嘆，兩者之間息息相關。自 14 世紀以來，全球債券殖利率普遍呈下降趨勢。與金融資產的其他主要宏觀變數和驅動因素一樣，這並非直線下降。當然，也有利率上升的時期，但總體趨勢是利率隨著時間大幅下降。</p>
            <h6>政府債務的超級週期</h6>
            <p>除了增長、通貨膨脹和利率之外，還有政府債務的超級週期證據。同樣，儘管經濟狀況對債務產生影響，但債務水準的長波顯示了經濟活動、通貨膨脹和政府政策之間的關鍵相互作用。</p>
            <h6>不平等的超級週期</h6>
            <p>歷史表明，不平等與上述其他宏觀經濟驅動因素一樣，也是週期性的，儘管它在長期趨勢中緩慢變化。</p>

            <h4>第二部分：分析戰後超級週期</h4>
            <p>本節詳細分析了戰後主要的超級週期，重點關注了其獨特的驅動因素和市場表現。</p>

            <h5>1949–1968：戰後繁榮</h5>
            <p>這個時期以強勁的戰後經濟繁榮為主導，通常被稱為「資本主義黃金時代」。它得到了美國通過馬歇爾計畫（或歐洲復甦計畫）對歐洲經濟援助的支援，這有助於促進增長和減少失業。生產力增長強勁，特別是在歐洲和東亞，戰後「嬰兒潮」進一步刺激了需求。</p>
            <ul>
                <li><strong>國際協定與風險溢價下降</strong>：戰後建立新的規則基礎經濟管理和國際貿易體系，降低了全球系統風險。</li>
                <li><strong>強勁的經濟增長</strong>：馬歇爾計畫等倡議推動了美國和歐洲的經濟快速增長。</li>
                <li><strong>技術創新</strong>：電視、晶體管、太空探索等創新改變了生活方式並促進了經濟增長。</li>
                <li><strong>低且穩定的實際利率</strong>：戰後重建和金融壓抑政策維持了低利率，幫助政府償還債務。</li>
                <li><strong>世界貿易的繁榮</strong>：GATT 等新組織的建立促進了全球貿易的大幅增長。</li>
                <li><strong>嬰兒潮</strong>：戰後人口的顯著增長刺激了消費需求和經濟活力。</li>
                <li><strong>消費與信貸繁榮</strong>：失業率下降、福利國家建立、信用卡創新等因素共同推動了消費和信貸的爆炸性增長。</li>
            </ul>

            <h5>1968–1982：通貨膨脹與低回報</h5>
            <p>從 1970 年代初到 1980 年代初，是投資者歷史上最糟糕的十年之一。通貨膨脹和利率飆升，加上兩次深度衰退和停滯不前的增長，在滯脹的環境下對股票和固定收益市場造成了壓力。這種組合導致了長達十多年的高波動性和低回報的「肥胖而平坦」環境。</p>
            <ul>
                <li><strong>投資者的「失落的十年」</strong>：儘管名義上股價指數有所上漲，但高通脹導致實際回報大幅降低。</li>
                <li><strong>高利率與低增長</strong>：通貨膨脹和利率飆升導致了兩次衰退，並長期伴隨經濟疲軟，最終導致了全球債務危機。</li>
                <li><strong>社會動盪與罷工</strong>：失業率飆升和生活成本上升導致了廣泛的罷工和社會動盪，反映在藝術和音樂中。</li>
                <li><strong>貿易崩潰、保護主義與管制加劇</strong>：多個國家的貿易失衡導致保護主義抬頭，企業利潤空間受到擠壓。</li>
                <li><strong>公共支出增加，利潤率下降</strong>：政府支出增加、工資上漲和企業管制導致企業利潤佔 GDP 的份額大幅下降。</li>
            </ul>

            <h5>1982–2000：現代週期</h5>
            <p>從 1982 年到 2000 年的長期牛市總體而言是一個金融市場回報豐厚且波動性低的時期。儘管如此，與大多數長期牛市一樣，它也經歷了多個週期。與 1970 年代的「肥胖而平坦」趨勢不同，1980 年代的衰退伴隨著通貨膨脹和利率的下降趨勢，這使得市場能夠產生強勁的回報。</p>
            <ul>
                <li><strong>大穩健時期</strong>：關鍵宏觀經濟變數的波動性顯著降低，有利於企業規劃和降低投資者的對沖成本。</li>
                <li><strong>通貨緊縮與較低的資本成本</strong>：通貨膨脹和利率大幅下降，推動了股票和債券的估值擴張，並刺激了企業盈利增長。歐洲單一貨幣的趨同進一步推動了全球利率下降。</li>
                <li><strong>貨幣政策與「聯準會看跌期權」</strong>：聯準會在市場下跌時降息的傾向成為長期牛市的核心支持機制，增加了投資者的信心。</li>
                <li><strong>供給側改革（包括解除管制和私有化）</strong>：里根和柴契爾政府推動了減稅、解除管制和私有化，提高了效率並吸引了外國投資。</li>
                <li><strong>蘇聯解體（地緣政治風險降低）</strong>：冷戰結束，美國的政治和經濟霸權得以鞏固，降低了地緣政治風險，刺激了資本流動。</li>
                <li><strong>全球化與合作</strong>：廣場協議和盧浮宮協議穩定貨幣，同時貿易協定和資本市場開放促進了全球貿易和外國直接投資的爆炸式增長。</li>
                <li><strong>中國與印度的影響</strong>：中國經濟特區的設立和印度改革開放，將大量廉價勞動力融入全球經濟，推動了全球製造業和服務業的增長。</li>
                <li><strong>泡沫與金融創新</strong>：經濟增長、低利率和「聯準會看跌期權」的信心導致了金融投機的增長，特別是衍生品市場的發展。日本資產泡沫和 2000 年的科技泡沫是這一時期金融投機的顯著例子。</li>
            </ul>

            <h5>2000–2009：泡沫與困境</h5>
            <p>2000 年至 2009 年的週期，與 1970 年代的週期一樣，可以被描述為「肥胖而平坦」——低回報被急劇下跌和強勁反彈的時期所打斷。這是一個泡沫和重大市場崩潰的十年，其基礎是日益加劇的地緣政治不確定性。</p>
            <ul>
                <li><strong>科技泡沫破裂</strong>：由廉價資金和強勁敘事推動的科技股泡沫破裂，導致估值大幅下跌，儘管該行業最終在低增長和低利率的環境下重新崛起。</li>
                <li><strong>2007-2009 年金融危機</strong>：繼 9/11 襲擊後，利率的迅速下調為新的投機浪潮創造了沃土，導致了美國的房地產繁榮，隨後在 2007 年破裂，引發了全球金融危機。</li>
                <li><strong>增長預期下降</strong>：金融危機後經濟復甦乏力，導致企業銷售增長預期下降，特別是在歐洲和日本。</li>
                <li><strong>股票風險溢價上升</strong>：不確定性加劇和對長期增長的擔憂導致投資者要求更高的股票風險溢價。</li>
                <li><strong>股票/債券負相關</strong>：由於對通貨緊縮的擔憂，利率下降對股票產生了負面影響，導致股票與債券之間出現負相關。</li>
            </ul>

            <h4>第三部分：後現代週期</h4>
            <p>本節探討了當前和未來可能定義「後現代週期」的結構性變化，這些變化將影響投資回報和行業領導力。</p>

            <h5>後現代週期</h5>
            <p>後現代週期的出現，將定義未來幾十年的市場。這個新時代可能表現出戰後傳統週期的一些特徵，例如更高的波動性和更弱的回報，但也將分享 1980 年後主導的現代週期的一些元素，例如低波動性和估值上升。</p>
            <ul>
                <li><strong>資本成本上升</strong>：長期的通貨緊縮趨勢結束，通貨膨脹重新出現，導致利率上升，從而推高資本成本。</li>
                <li><strong>趨勢增長放緩</strong>：全球化逆轉、人口結構變化和生產力增長乏力，導致長期經濟增長放緩。</li>
                <li><strong>從全球化轉向區域化</strong>：地緣政治緊張局勢加劇、供應鏈中斷和國家安全優先級提升，導致貿易模式從全球化轉向區域化。</li>
                <li><strong>勞動力和商品成本上升</strong>：脫離全球化、勞動力供應減少和能源轉型導致勞動力和商品成本結構性上升。</li>
                <li><strong>政府支出和債務增加</strong>：能源轉型、國防支出和產業政策等因素推動政府支出和債務大幅增加。</li>
                <li><strong>資本和基礎設施支出增加</strong>：為支援能源轉型和重建供應鏈，全球基礎設施和資本支出將大幅增加。</li>
                <li><strong>人口結構變化</strong>：人口老齡化和勞動力供應減少對生產力增長、儲蓄和投資模式產生重大影響。</li>
                <li><strong>地緣政治緊張局勢加劇與多極世界</strong>：地緣政治競爭加劇、中國崛起和多極世界秩序的出現增加了不確定性和波動性。</li>
            </ul>

            <h5>後現代週期與科技</h5>
            <p>科技和人工智慧（AI）將如何塑造後現代週期的市場回報。</p>
            <ul>
                <li><strong>技術革命的特點</strong>：技術革命通常伴隨著興奮、投機和泡沫，然後是行業的整合和主導公司的出現。</li>
                <li><strong>AI 和生產力的影響</strong>：AI 有望提高生產力，彌補過去幾十年生產力增長的不足。</li>
                <li><strong>PERL 框架</strong>：一個用於評估 AI 影響的框架，將公司分為先驅者（Pioneers）、推動者（Enablers）、適應者（Adaptors）、改革者（Reformers）和落後者（Laggards）。
                    <ul>
                        <li><strong>先驅者 (Pioneers)</strong>：這些公司創造了新技術，例如晶片製造商和基礎模型開發商。</li>
                        <li><strong>推動者 (Enablers)</strong>：這些公司提供了技術得以運行的基礎設施，例如雲端服務提供商和數據中心。</li>
                        <li><strong>適應者 (Adaptors)經</strong>：這些公司在非科技行業中採用新技術來改進其業務模式。</li>
                        <li><strong>改革者 (Reformers)</strong>：這些公司利用新技術從根本上改變行業，創造新的商業模式和市場。</li>
                        <li><strong>落後者 (Laggards)</strong>：這些公司未能適應新技術，可能面臨衰退或被淘汰的風險。</li>
                    </ul>
                </li>
            </ul>

            <h5>後現代週期：「舊經濟」中的機會</h5>
            <p>後現代週期中，將會有來自傳統產業和「舊經濟」的投資機會，特別是在脫碳和基礎設施支出增加的背景下。</p>
            <ul>
                <li><strong>國防支出</strong>：地緣政治緊張局勢加劇將推動全球國防支出增加，為相關公司帶來機會。</li>
                <li><strong>基礎設施支出</strong>：為支援能源轉型和重建供應鏈，全球基礎設施和資本支出將大幅增加。</li>
                <li><strong>綠色支出</strong>：全球對脫碳的承諾將驅動大量綠色投資，為可再生能源、電動車和電池等行業創造機會。</li>
                <li><strong>政府政策與支出</strong>：政府的產業政策和財政補貼將引導投資流向關鍵行業，例如半導體和清潔能源。</li>
                <li><strong>商品支出</strong>：能源轉型和基礎設施投資將增加對關鍵金屬和商品的長期需求。</li>
                <li><strong>工作未來</strong>：AI 和自動化將改變勞動力市場，但預計新興產業也將創造大量新工作。</li>
                <li><strong>懷舊行銷的力量</strong>：在高度數位化和快速變化的世界中，消費者對「真實性」和懷舊的渴望將推動相關產品和服務的增長。</li>
            </ul>
        </div>
    </div>

    <script>
        // 後端 API 基礎 URL
        const API_BASE_URL = 'https://stock-ai-backend-api.onrender.com/api';

        let base64Images = []; // 儲存多張 Base64 圖片的陣列
        // 用於儲存上一次分析結果的變量，以便後續提問時提供上下文
        let lastAnalysisResults = {
            keyPrice: '',
            details: ''
        };

        /**
         * @function previewMultipleImages
         * @description 預覽多張圖片，將其轉換為Base64並儲存
         * @param {Event} event - input file change event
         */
        function previewMultipleImages(event) {
            const files = event.target.files;
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            imagePreviewContainer.innerHTML = ''; // 清除之前的預覽
            base64Images = []; // 清除之前的 Base64 數據

            if (files.length === 0) {
                return;
            }

            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" class="preview-image" alt="Image ${index + 1}">
                        <button class="remove-image-btn" data-index="${index}">&times;</button>
                    `;
                    imagePreviewContainer.appendChild(previewItem);
                    const mimeType = file.type;
                    base64Images.push({ index: index, data: e.target.result.split(',')[1], mimeType: mimeType });

                    // 為移除按鈕添加事件監聽器
                    previewItem.querySelector('.remove-image-btn').onclick = function() {
                        removeImage(index, previewItem);
                    };
                };
                reader.readAsDataURL(file);
            });
        }

        /**
         * @function removeImage
         * @description 移除預覽圖片和對應的Base64數據
         * @param {number} indexToRemove - 要移除的圖片的索引
         * @param {HTMLElement} previewItemElement - 要移除的預覽圖片元素
         */
        function removeImage(indexToRemove, previewItemElement) {
            previewItemElement.remove(); // 從 DOM 中移除

            // 從 base64Images 陣列中移除
            base64Images = base64Images.filter(item => item.index !== indexToRemove);

            // 重新索引剩餘圖像（確保索引一致性）
            base64Images = base64Images.map((item, newIndex) => ({
                ...item,
                index: newIndex
            }));

            // 更新移除按鈕上的 data-index
            document.querySelectorAll('.remove-image-btn').forEach((btn, newIndex) => {
                btn.setAttribute('data-index', newIndex);
            });
        }

        /**
         * @function analyzeSentiment
         * @description 分析輸入文本的情緒並顯示結果
         */
        async function analyzeSentiment() {
            const sentimentText = document.getElementById('sentimentText').value;
            const sentimentResultsDiv = document.getElementById('sentimentResults');
            const analyzeSentimentButton = document.getElementById('analyzeSentimentButton');
            const sentimentButtonText = document.getElementById('sentimentButtonText');
            const sentimentLoadingAnimation = document.getElementById('sentimentLoadingAnimation');

            // 清除之前的結果
            sentimentResultsDiv.innerHTML = '';

            if (!sentimentText.trim()) {
                sentimentResultsDiv.innerHTML = '<p class="text-red-600 font-semibold">請輸入文本以進行情緒分析。</p>';
                return;
            }

            // 顯示載入中狀態
            sentimentButtonText.textContent = '分析中...';
            sentimentLoadingAnimation.classList.remove('hidden');
            analyzeSentimentButton.disabled = true;

            try {
                // 構建提示詞，要求進行情緒分析和摘要
                const prompt = `請對以下文本進行市場情緒分析和摘要。識別主要情緒（正面、負面、中性），並提取關鍵資訊。\n\n文本：\n"${sentimentText}"`;

                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas 將自動提供 API key

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    // 使用 marked.js 將 Markdown 渲染為 HTML
                    sentimentResultsDiv.innerHTML = marked.parse(text);
                } else {
                    sentimentResultsDiv.innerHTML = '<p class="text-red-600 font-semibold">分析失敗：未從AI獲取到有效回應。</p>';
                }
            } catch (error) {
                console.error('情緒分析失敗:', error);
                sentimentResultsDiv.innerHTML = `<p class="text-red-600 font-semibold">情緒分析失敗，請重試。錯誤：${error.message}</p>`;
            } finally {
                // 重置按鈕狀態
                sentimentButtonText.textContent = '分析市場情緒';
                sentimentLoadingAnimation.classList.add('hidden');
                analyzeSentimentButton.disabled = false;
            }
        }

        /**
         * @function analyzeStockAndOptions
         * @description 綜合分析股票與期權資訊，並顯示結果
         */
        async function analyzeStockAndOptions() {
            const stockDescription = document.getElementById('stockDescription').value;
            const optionDescription = document.getElementById('optionDescription').value;
            const generalInfo = document.getElementById('generalInfo').value;
            const sentimentResults = document.getElementById('sentimentResults').innerText; // 獲取情緒分析結果文本
            const keyPricePointsResultsDiv = document.getElementById('keyPricePointsResults');
            const analysisDetailsResultsDiv = document.getElementById('analysisDetailsResults');
            const analyzeButton = document.getElementById('analyzeButton');
            const buttonText = document.getElementById('buttonText');
            const loadingAnimation = document.getElementById('loadingAnimation');
            const finalClosingSection = document.getElementById('finalClosingSection');
            const technicalAnalysisContent = document.getElementById('technicalAnalysisContent').innerHTML;
            const marketSuperCyclesContent = document.getElementById('marketSuperCyclesContent').innerHTML;
            const followUpResultsDiv = document.getElementById('followUpResults');

            // 清除之前的結果
            keyPricePointsResultsDiv.innerHTML = '<p class="text-gray-600">此處將顯示關鍵的進場、出場、支撐、阻力與目標價位資訊。</p>';
            analysisDetailsResultsDiv.innerHTML = '<p class="text-gray-600">此處將顯示技術分析、期權信息整合、市場情緒等詳細內容。</p>';
            followUpResultsDiv.innerHTML = '<p class="text-gray-600">此處將顯示您對分析結果的進一步提問的回答。</p>'; // 清除後續提問結果
            finalClosingSection.classList.add('hidden'); // 隱藏祝福語

            // 檢查是否提供了足夠的輸入
            if (!stockDescription.trim() && !optionDescription.trim() && !generalInfo.trim() && base64Images.length === 0 && !sentimentResults.trim()) {
                keyPricePointsResultsDiv.innerHTML = '<p class="text-red-600 font-semibold">請至少提供股票描述、期權資訊、通用資訊或上傳圖表，才能進行分析。</p>';
                return;
            }

            // 顯示載入中狀態
            buttonText.textContent = '分析中...';
            loadingAnimation.classList.remove('hidden');
            analyzeButton.disabled = true;

            try {
                let promptParts = [];
                promptParts.push("請根據以下提供的股票圖表、描述、期權資訊、通用資訊和市場情緒，對當前股票/期權狀況進行詳細的綜合分析。分析應涵蓋技術分析（K線圖、圖表型態、支撐阻力）、期權信息整合、市場情緒影響，並給出關鍵價位概覽和潛在目標價。請參考下方提供的技術分析知識和市場超級週期理論進行更深入的分析。\n\n");

                if (base64Images.length > 0) {
                    promptParts.push("以下是上傳的股票/期權相關圖表：");
                    base64Images.forEach((img, idx) => {
                        promptParts.push(`[Image of 圖表 ${idx + 1}]`); // 用圖像描述佔位符
                    });
                    promptParts.push("\n");
                }

                if (stockDescription.trim()) {
                    promptParts.push(`個股相關描述：${stockDescription}\n`);
                }
                if (optionDescription.trim()) {
                    promptParts.push(`期權相關資訊：${optionDescription}\n`);
                }
                if (generalInfo.trim()) {
                    promptParts.push(`其他通用資訊：${generalInfo}\n`);
                }
                if (sentimentResults.trim() && sentimentResults !== '此處將顯示情緒分析結果。') { // 排除初始占位符文本
                    promptParts.push(`市場情緒分析結果：${sentimentResults}\n`);
                }

                promptParts.push(`\n\n--- 技術分析參考資料 ---\n${technicalAnalysisContent}\n\n`);
                promptParts.push(`\n\n--- 市場超級週期參考資料 ---\n${marketSuperCyclesContent}\n\n`);
                promptParts.push("請按照以下兩個區塊輸出結果：\n\n");
                promptParts.push("### 關鍵價位與潛在目標價概覽\n請提供關鍵的進場價位、出場價位、支撐位、阻力位和潛在目標價。請使用Markdown表格形式呈現，並簡要說明其依據。\n\n");
                promptParts.push("### 詳細綜合分析結果\n請提供以下方面的詳細分析：\n1.  **技術分析**：根據上傳圖表（若有）和提供的描述，識別K線圖型態、圖表型態（如頭肩頂、雙重底、旗形等），並分析支撐與阻力位、趨勢線，以及成交量對趨勢的確認。請引用提供的技術分析參考資料。\n2.  **期權信息整合**：結合期權交易量、未平倉合約、隱含波動率等信息，分析市場預期和潛在波動性，並與股票走勢進行綜合判斷。\n3.  **市場情緒影響**：結合市場情緒分析結果（若有），說明其對股票和期權市場的影響。\n4.  **宏觀經濟/超級週期考量**：結合通用資訊和提供的市場超級週期參考資料，討論相關宏觀經濟因素和當前所處的市場超級週期階段對標的資產的潛在影響。\n5.  **綜合判斷與策略建議**：基於上述所有分析，給出一個綜合判斷，並提供潛在的交易或投資策略建議（例如：看漲、看跌、區間操作，以及考慮買入看漲/看跌期權或相關套利策略）。\n\n請務必輸出Markdown格式的內容。");


                const fullPrompt = promptParts.join('');

                // 構建 API 請求的 parts 陣列
                let requestParts = [{ text: fullPrompt }];
                base64Images.forEach(img => {
                    requestParts.push({
                        inlineData: {
                            mimeType: img.mimeType,
                            data: img.data
                        }
                    });
                });

                const chatHistory = [{ role: "user", parts: requestParts }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas 將自動提供 API key

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;

                    // 將結果分割成兩個部分
                    const parts = text.split('### 詳細綜合分析結果');
                    if (parts.length > 1) {
                        const keyPriceMarkdown = parts[0];
                        const analysisDetailsMarkdown = '### 詳細綜合分析結果' + parts[1]; // 加上標題

                        keyPricePointsResultsDiv.innerHTML = marked.parse(keyPriceMarkdown);
                        analysisDetailsResultsDiv.innerHTML = marked.parse(analysisDetailsMarkdown);
                        
                        // 儲存最新的分析結果，供後續提問使用
                        lastAnalysisResults.keyPrice = keyPriceMarkdown;
                        lastAnalysisResults.details = analysisDetailsMarkdown;

                        finalClosingSection.classList.remove('hidden'); // 顯示祝福語
                    } else {
                        // 如果沒有分割成功，則全部顯示在詳細分析中
                        analysisDetailsResultsDiv.innerHTML = marked.parse(text);
                        keyPricePointsResultsDiv.innerHTML = '<p class="text-red-orange-600 font-semibold">未能解析出關鍵價位概覽，請查看詳細綜合分析。</p>';
                        
                        // 儲存最新的分析結果
                        lastAnalysisResults.keyPrice = ''; // 清空，因為沒有單獨解析
                        lastAnalysisResults.details = text;

                        finalClosingSection.classList.remove('hidden');
                    }

                } else {
                    analysisDetailsResultsDiv.innerHTML = '<p class="text-red-600 font-semibold">綜合分析失敗：未從AI獲取到有效回應。</p>';
                }
            } catch (error) {
                console.error('綜合分析失敗:', error);
                analysisDetailsResultsDiv.innerHTML = `<p class="text-red-600 font-semibold">綜合分析失敗，請重試。錯誤：${error.message}</p>`;
            } finally {
                // 重置按鈕狀態
                buttonText.textContent = '開始綜合分析';
                loadingAnimation.classList.add('hidden');
                analyzeButton.disabled = false;
            }
        }

        /**
         * @function getSuggestionsForAdditionalData
         * @description 根據現有輸入提供增強分析的資料建議
         */
        async function getSuggestionsForAdditionalData() {
            const stockDescription = document.getElementById('stockDescription').value;
            const optionDescription = document.getElementById('optionDescription').value;
            const generalInfo = document.getElementById('generalInfo').value;
            const sentimentResults = document.getElementById('sentimentResults').innerText; // 獲取情緒分析結果文本
            const suggestionResultsDiv = document.getElementById('suggestionResults');
            const getSuggestionsButton = document.getElementById('getSuggestionsButton');
            const suggestionsButtonText = document.getElementById('suggestionsButtonText');
            const suggestionsLoadingAnimation = document.getElementById('suggestionsLoadingAnimation');

            // 清除之前的結果
            suggestionResultsDiv.innerHTML = '<p class="text-gray-600">點擊上方按鈕，AI 將根據您目前的輸入，建議可補充的資料類型。</p>';

            // 顯示載入中狀態
            suggestionsButtonText.textContent = '獲取建議中...';
            suggestionsLoadingAnimation.classList.remove('hidden');
            getSuggestionsButton.disabled = true;

            try {
                let currentInputs = [];
                if (stockDescription.trim()) currentInputs.push("個股相關描述");
                if (optionDescription.trim()) currentInputs.push("期權相關資訊描述");
                if (generalInfo.trim()) currentInputs.push("其他通用資訊");
                if (base64Images.length > 0) currentInputs.push("上傳的圖表");
                if (document.getElementById('sentimentText').value.trim() && document.getElementById('sentimentText').value.trim() !== '此處將顯示情緒分析結果。') { // Ensure actual sentiment text is present
                    currentInputs.push("市場情緒分析文本");
                }


                let prompt = "根據用戶當前已提供的以下信息，請建議還可以補充哪些類型的數據或信息，以便對股票和期權進行更全面、深入的分析。請具體說明為什麼這些數據會有所幫助，並以Markdown列表形式列出建議。\n\n";
                if (currentInputs.length > 0) {
                    prompt += `用戶目前已提供：${currentInputs.join("、") || "無"}\n\n`;
                } else {
                    prompt += `用戶目前未提供任何資訊。請建議一些基礎的股票和期權分析所需數據。\n\n`;
                }
                prompt += "建議：\n";

                console.log("Suggestions Prompt:", prompt); // Log the prompt

                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas 將自動提供 API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log("Suggestions API Raw Response:", response); // Log raw response

                const result = await response.json();
                console.log("Suggestions API Parsed Result:", result); // Log parsed JSON result

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    suggestionResultsDiv.innerHTML = marked.parse(text);
                } else {
                    // Check for specific error messages from the API
                    if (result.error && result.error.message) {
                        suggestionResultsDiv.innerHTML = `<p class="text-red-600 font-semibold">獲取建議失敗：AI回應錯誤 - ${result.error.message}</p>`;
                    } else {
                        suggestionResultsDiv.innerHTML = '<p class="text-red-600 font-semibold">獲取建議失敗：未從AI獲取到有效回應。</p>';
                    }
                }
            } catch (error) {
                console.error('獲取建議失敗:', error);
                suggestionResultsDiv.innerHTML = `<p class="text-red-600 font-semibold">獲取建議失敗，請重試。錯誤：${error.message}</p>`;
            } finally {
                // 重置按鈕狀態
                suggestionsButtonText.textContent = '獲取增強分析的資料建議';
                suggestionsLoadingAnimation.classList.add('hidden');
                getSuggestionsButton.disabled = false;
            }
        }

        /**
         * @function askFollowUpQuestion
         * @description 根據之前的分析結果和用戶的新問題進行更深入的分析
         */
        async function askFollowUpQuestion() {
            const followUpQuestionText = document.getElementById('followUpQuestionText').value;
            const followUpResultsDiv = document.getElementById('followUpResults');
            const askFollowUpButton = document.getElementById('askFollowUpButton');
            const followUpButtonText = document.getElementById('followUpButtonText');
            const followUpLoadingAnimation = document.getElementById('followUpLoadingAnimation');

            // 清除之前的後續提問結果
            followUpResultsDiv.innerHTML = '';

            if (!followUpQuestionText.trim()) {
                followUpResultsDiv.innerHTML = '<p class="text-red-600 font-semibold">請輸入您的問題。</p>';
                return;
            }

            // 檢查是否有先前的分析結果作為上下文
            if (!lastAnalysisResults.keyPrice && !lastAnalysisResults.details) {
                followUpResultsDiv.innerHTML = '<p class="text-red-600 font-semibold">請先執行一次綜合分析，才能針對結果進行提問。</p>';
                return;
            }

            // 顯示載入中狀態
            followUpButtonText.textContent = '分析中...';
            followUpLoadingAnimation.classList.remove('hidden');
            askFollowUpButton.disabled = true;

            try {
                let prompt = "根據我之前提供的股票/期權綜合分析結果，請回答我的以下問題。請確保您的回答基於先前的分析內容，並提供深入的見解。\n\n";
                
                // 包含上一次的分析結果作為上下文
                if (lastAnalysisResults.keyPrice) {
                    prompt += `--- 先前關鍵價位與潛在目標價概覽 ---\n${lastAnalysisResults.keyPrice}\n\n`;
                }
                if (lastAnalysisResults.details) {
                    prompt += `--- 先前詳細綜合分析結果 ---\n${lastAnalysisResults.details}\n\n`;
                }

                prompt += `我的問題是：「${followUpQuestionText}」\n\n請以Markdown格式回答。`;

                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas 將自動提供 API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    followUpResultsDiv.innerHTML = marked.parse(text);
                } else {
                    if (result.error && result.error.message) {
                        followUpResultsDiv.innerHTML = `<p class="text-red-600 font-semibold">提問失敗：AI回應錯誤 - ${result.error.message}</p>`;
                    } else {
                        followUpResultsDiv.innerHTML = '<p class="text-red-600 font-semibold">提問失敗：未從AI獲取到有效回應。</p>';
                    }
                }
            } catch (error) {
                console.error('後續提問失敗:', error);
                followUpResultsDiv.innerHTML = `<p class="text-red-600 font-semibold">後續提問失敗，請重試。錯誤：${error.message}</p>`;
            } finally {
                // 重置按鈕狀態
                followUpButtonText.textContent = '提問';
                followUpLoadingAnimation.classList.add('hidden');
                askFollowUpButton.disabled = false;
            }
        }
    </script>
</body>
</html>
